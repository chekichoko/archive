<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>캐릭터 아카이브</title>
    
    <!-- 필수 도구 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase (호환성 버전) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
        
        :root {
            --sage-bg: #F1F5F2;
            --sage-primary: #98B0A0;
            --sage-text: #4D5A51;
            --sage-border: #E2EAE5;
        }

        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: var(--sage-bg);
            color: var(--sage-text);
            margin: 0; padding: 0;
            font-size: 12px;
        }

        * { font-size: 12px; box-sizing: border-box; }
        
        .text-header { font-size: 40px !important; font-weight: 900; letter-spacing: -0.02em; }
        .text-sub { font-size: 16px !important; font-weight: 700; }
        .text-card { font-size: 14px !important; font-weight: 700; }

        .rounded-2xl { border-radius: 1rem !important; }
        .shadow-soft { box-shadow: 0 4px 20px -2px rgba(152, 176, 160, 0.15); }
        
        .timeline-wrapper { position: relative; padding-left: 24px; padding-bottom: 32px; }
        .timeline-line {
            position: absolute; left: 7px; top: 16px; bottom: 0; width: 2px; background-color: #C8D1CC;
        }
        .timeline-dot {
            position: absolute; left: 0; top: 0; width: 16px; height: 16px;
            background-color: white; border: 3px solid var(--sage-primary); border-radius: 50%; z-index: 10;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        button:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 아이콘 직접 정의 (로딩 오류 방지)
        const Icons = {
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Edit2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Share2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>,
            Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            FileText: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            UserCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg>,
            History: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Copy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Wifi: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>,
            WifiOff: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="2" x2="22" y1="2" y2="22"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M5 12.55a11 11 0 0 1 14.08 0"/></svg>
        };

        // 데이터 관리자 (하이브리드 엔진)
        const DataService = {
            useFirebase: false,
            appId: 'my-archive',
            
            init: function(configStr) {
                try {
                    // Firebase 설정이 있고, 로드 성공 시 시도
                    if (configStr && window.firebase && window.firebase.apps) {
                        const config = JSON.parse(configStr);
                        if (!firebase.apps.length) firebase.initializeApp(config);
                        this.useFirebase = true;
                        console.log("온라인 모드(Firebase) 준비 완료");
                    } else {
                        console.warn("설정 없음/로드 실패: 로컬 모드로 동작");
                        this.useFirebase = false;
                    }
                } catch (e) {
                    this.useFirebase = false;
                }
            },

            // 데이터 구독
            subscribe: function(appId, callback) {
                if (this.useFirebase) {
                    try {
                        const db = firebase.firestore();
                        return db.collection('artifacts').doc(appId).collection('public').doc('data').collection('characters')
                            .onSnapshot(snapshot => {
                                const fetched = {};
                                snapshot.forEach(doc => {
                                    const d = doc.data();
                                    const group = d.mythName || '미분류';
                                    if (!fetched[group]) fetched[group] = [];
                                    fetched[group].push({ ...d, id: doc.id });
                                });
                                callback(fetched, true); // true = online
                            }, err => {
                                console.warn("연결 실패, 로컬 전환");
                                callback(this.getLocalData(appId), false); // false = offline
                            });
                    } catch (e) {
                        callback(this.getLocalData(appId), false);
                        return () => {};
                    }
                } else {
                    callback(this.getLocalData(appId), false);
                    // 로컬 변경 감지
                    const handler = () => callback(this.getLocalData(appId), false);
                    window.addEventListener('local-data-update', handler);
                    return () => window.removeEventListener('local-data-update', handler);
                }
            },

            getLocalData: function(appId) {
                try {
                    const stored = localStorage.getItem(`archive_${appId}`);
                    return stored ? JSON.parse(stored) : {};
                } catch(e) { return {}; }
            },

            saveLocalData: function(appId, data) {
                localStorage.setItem(`archive_${appId}`, JSON.stringify(data));
                window.dispatchEvent(new Event('local-data-update'));
            },

            // 쓰기 작업 (자동 분기)
            saveChar: async function(appId, id, data) {
                if (this.useFirebase) {
                    try {
                        await firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection('characters').doc(id).set(data);
                        return; // 성공 시 종료
                    } catch(e) { console.warn("전송 실패, 로컬 저장"); }
                }
                
                // 로컬 저장 (Firebase 실패 시 백업 혹은 로컬 모드일 때)
                const current = this.getLocalData(appId);
                // 기존 데이터 정리 (그룹 이동 등 대비)
                for (const group in current) {
                    current[group] = current[group].filter(c => c.id !== id);
                    if(current[group].length === 0) delete current[group];
                }
                // 새 데이터 추가
                const group = data.mythName || '미분류';
                if(!current[group]) current[group] = [];
                current[group].push({ ...data, id });
                this.saveLocalData(appId, current);
            },

            deleteChar: async function(appId, id) {
                if (this.useFirebase) {
                    try {
                        await firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection('characters').doc(id).delete();
                        return;
                    } catch(e) {}
                }
                const current = this.getLocalData(appId);
                for (const group in current) {
                    current[group] = current[group].filter(c => c.id !== id);
                    if(current[group].length === 0) delete current[group];
                }
                this.saveLocalData(appId, current);
            },
            
            importData: async function(appId, importedData) {
                if(this.useFirebase) {
                   const batch = firebase.firestore().batch();
                   const col = firebase.firestore().collection('artifacts').doc(appId).collection('public').doc('data').collection('characters');
                   Object.values(importedData).flat().forEach(c => {
                       batch.set(col.doc(c.id || Date.now().toString()), c);
                   });
                   await batch.commit();
                } else {
                   this.saveLocalData(appId, importedData);
                }
            }
        };

        const App = () => {
            const [data, setData] = useState({});
            const [viewMode, setViewMode] = useState('list');
            const [isOnline, setIsOnline] = useState(false);
            
            // 앱 설정
            const [appId, setAppId] = useState('my-archive');
            const [tempAppId, setTempAppId] = useState('');

            // 입력 폼
            const [form, setForm] = useState({ mythName: '', name: '', summary: '' });
            
            // 상세/수정 모달
            const [selectedChar, setSelectedChar] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [editForm, setEditForm] = useState({});
            
            // 일지
            const [logDate, setLogDate] = useState(new Date().toISOString().split('T')[0]);
            const [logText, setLogText] = useState('');

            // 초기화
            useEffect(()


